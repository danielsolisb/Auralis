{% extends 'main/dashboard.html' %}
{% load static %}

{% block fixedbar %}{% endblock %}

{% block content %}
<div id="page-content">
  <div class="row">
    <div class="col-lg-12">
      <div class="panel monitor-panel">

        <!-- BARRA SUPERIOR -->
        <div class="panel-heading compact">
          <div class="monitor-toolbar">
            <!-- Estación -->
            <div class="station-input">
              <label for="station-select" class="sr-only">Estación</label>
              <select id="station-select" class="form-control">
                <option value="">Selecciona una estación…</option>
                {% for st in stations %}
                  <option value="{{ st.id }}" data-name="{{ st.name }}">{{ st.name }}</option>
                {% endfor %}
              </select>
              <button id="load-sensors-btn" class="btn btn-primary btn-sm">Cargar</button>
            </div>

            <!-- Rangos -->
            <div class="range-chips">
              <span class="chip" data-range="5m">5m</span>
              <span class="chip" data-range="30m">30m</span>
              <span class="chip" data-range="1h">1h</span>
              <span class="chip" data-range="3h">3h</span>
              <span class="chip" data-range="6h">6h</span>
              <span class="chip" data-range="12h">12h</span>
            </div>

            <!-- Vivo -->
            <div class="live-tools">
              <span class="live-indicator on" id="live-indicator">En vivo</span>
              <button id="back-to-live" class="btn btn-link btn-xs" style="display:none;">Volver al vivo</button>
            </div>
          </div>
        </div>

        <!-- CONTENIDO -->
        <div class="panel-body monitor-flex">
          <!-- IZQUIERDA: gráfico -->
          <div class="chart-wrap">
            <div id="multiscale-chart"></div>
          </div>

          <!-- DERECHA: valores en vivo -->
          <aside class="side-wrap">
            <div class="panel values-panel">
              <div class="panel-body" id="values-panel-tech"></div>
            </div>
          </aside>
        </div>

      </div>
    </div>
  </div>
</div>

<style>
  /* ===== Layout compacto ===== */
  .monitor-panel .panel-heading.compact{ padding:5px 7px 12px; }
  .monitor-toolbar{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }

  .station-input{ display:flex; align-items:center; gap:8px; }
  .station-input select{ min-width:260px; }
  #load-sensors-btn{ white-space:nowrap; }

  .monitor-flex{ display:flex; gap:14px; }
  .monitor-panel .panel-body{ padding:8px; }   /* menos padding lateral */
  .chart-wrap{ flex:1 1 auto; min-height:520px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; }
  #multiscale-chart{ width:100%; height:520px; }

  /* ↓↓↓ panel más angosto */
  .side-wrap{ width:240px; flex:0 0 240px; }
  .values-panel{ border:1px solid #e5e7eb; border-radius:12px; }

  /* ===== Panel derecho (2 líneas) ===== */
  #values-panel-tech .panel-body{ padding:8px; }
  #values-panel-tech .live-card{
    padding:10px 12px; border-bottom:1px dashed #e9ecef; cursor:pointer;
  }
  #values-panel-tech .live-card:last-child{ border-bottom:none; }
  #values-panel-tech .live-card.active{ background:#f8fafc; }

  #values-panel-tech .head{ display:flex; align-items:center; gap:8px; }
  #values-panel-tech .color-dot{ width:12px; height:12px; border-radius:999px; display:inline-block; flex:0 0 12px; }
  #values-panel-tech .name-text{
    flex:1 1 auto; min-width:0; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  #values-panel-tech .colon{ color:#9aa0a6; margin-left:4px; }

  #values-panel-tech .reading{
    margin-top:2px; display:flex; align-items:baseline; gap:6px;
    white-space:nowrap; font-variant-numeric:tabular-nums;
  }
  #values-panel-tech .val{ font-size:1.05em; font-weight:600; line-height:1; }
  #values-panel-tech .unit{ color:#6c757d; font-size:.85em; }

  .range-chips{ display:flex; flex-wrap:wrap; gap:8px; }
  .range-chips .chip{ border:1px solid #cfd4da; border-radius:999px; padding:6px 12px; background:#fff; font-size:12px; cursor:pointer; }
  .range-chips .chip.active{ background:#0d6efd; color:#fff; border-color:#0d6efd; }

  .live-indicator{ font-size:12px; color:#6c757d; }
  .live-indicator.on::before{ content:''; display:inline-block; width:8px; height:8px; border-radius:50%; background:#28a745; margin-right:6px; vertical-align:middle; }
  .live-indicator.off::before{ content:''; display:inline-block; width:8px; height:8px; border-radius:50%; background:#dc3545; margin-right:6px; vertical-align:middle; }
</style>



{% endblock %}

{% block script %}
<!-- Librerías -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

<!-- Config inline para el JS modular -->
<script>
  window.MONTEC_CONFIG = {
    pageTitle: "Monitor Multiescala",
    mqtt: { host: "{{ mqtt_broker_ip }}", port: {{ mqtt_broker_port }} },
    apis: {
      sensors: "{% url 'get_station_sensors' station_id=0 %}".replace("/0/", "/{station_id}/"),
      history: "{% url 'get_station_history' station_id=0 %}".replace("/0/", "/{station_id}/")
    }
  };
</script>

<!-- Módulo JS -->
<script src="{% static 'js/monitor_tecnico.js' %}"></script>

<!-- (Opcional) Fallback inline: si por algún motivo no carga el JS externo, descomenta el bloque siguiente y pega ahí el contenido de monitor_tecnico.js -->
{# 
<script>
  // Fallback aquí si hiciera falta.
</script>
#}
{% endblock %}
